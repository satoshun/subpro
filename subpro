#!/bin/bash

PROJECT_DIR=~/.subpro/
BASE_CONFIG_DIR=${PROJECT_DIR}base/
SUBLIME_CMD="Sublime Text"
PROJECT_SUFFIX=sublime-project


_open_sublime_project()
{
    if [ -n "$1" ]; then
        open -a "${SUBLIME_CMD}" "$1"
        return 0
    fi

    return 1
}

open_sublime_project()
{
    find "${PROJECT_DIR}" -name "$1.${PROJECT_SUFFIX}" | while read path
    do
        _open_sublime_project "$path"

        if [ $? -eq 0 ]; then
            return 0
        fi
    done
}

delete_sublime_project()
{
    for suffix in "${PROJECT_SUFFIX}" sublime-workspace
    do
        filename=${1}.${suffix}
        find "${PROJECT_DIR}" -name "*.${suffix}" | while read path
        do
            if [[ $path =~ /"${filename}"$  ]]; then
                echo "delete ${path}"
                rm "${path}"
                break
            fi
        done
    done
}

create_sublime_project()
{
    group=$1
    if [ -n "$3" ]; then
        dest_project=$3
    else
        dest_project=$2
    fi

    dest="${PROJECT_DIR}${group}/${dest_project}.${PROJECT_SUFFIX}"

    mkdir -p "${PROJECT_DIR}${group}"

    if [ -a "${BASE_CONFIG_DIR}${group}.${PROJECT_SUFFIX}" ]; then
        cp "${BASE_CONFIG_DIR}${group}.${PROJECT_SUFFIX}" "$dest"
    else
        cp "${BASE_CONFIG_DIR}base.${PROJECT_SUFFIX}" "$dest"
    fi

    target="\"path\": \"`pwd`/${2}\","
    escape=`echo $target | sed "s/\//\\\\\\\\\//g"`
    sed -i '' -e "s/\"path\":.*/${escape}/" "$dest"

    _open_sublime_project "$dest"
}

show_usage()
{
    echo "Example usage:"
    echo "  subpro [project]"
    echo "  subpro create|c [package] [project path] [name]"
    echo "  subpro delete|del|d [project]"
}


case $# in
    0) show_usage ;;
    1) open_sublime_project $1 ;;
    2) case "$1" in
            d | del | delete)
                delete_sublime_project $2 ;;
       esac
       ;;
    *) case "$1" in
           c | create)
                create_sublime_project $2 $3 $4 $5 ;;
       esac
       ;;
esac
